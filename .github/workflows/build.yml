name: Build Core

on:
  push:
    branches: [main, claude/**]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compile with Quartus
        uses: raetro/quartus-flow@v1
        with:
          project: ap_core
          version: pocket
          project_folder: src/fpga

      - name: Reverse bitstream
        run: |
          python3 << 'PYEOF'
          with open('src/fpga/output_files/ap_core.rbf', 'rb') as f:
              data = f.read()
          reversed_data = bytes(int('{:08b}'.format(b)[::-1], 2) for b in data)
          with open('src/fpga/output_files/bitstream.rbf_r', 'wb') as f:
              f.write(reversed_data)
          PYEOF

      - name: Compute version
        id: version
        run: |
          LAST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LAST_TAG" ]; then
            NEXT_VERSION="1.0.0"
          else
            VERSION="${LAST_TAG#v}"
            MAJOR=$(echo "$VERSION" | cut -d. -f1)
            MINOR=$(echo "$VERSION" | cut -d. -f2)
            PATCH=$(echo "$VERSION" | cut -d. -f3)
            PATCH=$((PATCH + 1))
            NEXT_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi
          echo "version=$NEXT_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=v$NEXT_VERSION" >> "$GITHUB_OUTPUT"

      - name: Stamp version into core.json
        run: |
          python3 << PYEOF
          import json, datetime
          with open('dist/Cores/ericlewis.LunarLander/core.json', 'r') as f:
              data = json.load(f)
          data['core']['metadata']['version'] = '${{ steps.version.outputs.version }}'
          data['core']['metadata']['date_release'] = datetime.date.today().isoformat()
          with open('dist/Cores/ericlewis.LunarLander/core.json', 'w') as f:
              json.dump(data, f, indent=4)
              f.write('\n')
          PYEOF

      - name: Package core
        run: |
          mkdir -p release/Cores/ericlewis.LunarLander
          cp src/fpga/output_files/bitstream.rbf_r release/Cores/ericlewis.LunarLander/
          cp -r dist/Cores/ericlewis.LunarLander/*.json release/Cores/ericlewis.LunarLander/
          cp dist/Cores/ericlewis.LunarLander/icon.bin release/Cores/ericlewis.LunarLander/
          cp dist/Cores/ericlewis.LunarLander/info.txt release/Cores/ericlewis.LunarLander/
          cp -r dist/Assets release/
          cp -r dist/Platforms release/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: LunarLander-${{ steps.version.outputs.version }}
          path: release/

      - name: Create release zip
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        working-directory: release
        run: zip -r ../ericlewis.LunarLander-${{ steps.version.outputs.version }}.zip .

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            "ericlewis.LunarLander-${{ steps.version.outputs.version }}.zip" \
            --title "Lunar Lander ${{ steps.version.outputs.tag }}" \
            --generate-notes
